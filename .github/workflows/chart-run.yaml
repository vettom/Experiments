name: Helm Chart CI

on:
  workflow_dispatch: # manual trigger
  pull_request:
    paths:
      - 'Helm-charts/**'  # only trigger if helm charts are modified
jobs:
  detect-changes:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # ðŸ‘ˆ ensure history is available for git diff

      - name: Get changed helm chart directories
        id: changes
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE=origin/${{ github.base_ref }}
            HEAD=HEAD
            echo "Comparing changes against $BASE..."
            CHANGED_DIRS=$(git diff --name-only $BASE...$HEAD -- repo/Helm-charts/ | cut -d/ -f1-3 | sort -u)
          elif [ "${{ github.event_name }}" = "push" ]; then
            BASE=${{ github.event.before }}
            HEAD=${{ github.sha }}
            echo "Comparing changes between $BASE and $HEAD..."
            CHANGED_DIRS=$(git diff --name-only $BASE $HEAD -- repo/Helm-charts/ | cut -d/ -f1-3 | sort -u)
          else
            # for manual workflow_dispatch, take all chart dirs
            CHANGED_DIRS=$(find repo/Helm-charts -mindepth 1 -maxdepth 1 -type d)
          fi

          echo "Changed directories:"
          echo "$CHANGED_DIRS"

          # Save as step output
          echo "dirs=$CHANGED_DIRS" >> $GITHUB_OUTPUT

      - name: Show output in next step
        run: |
          echo "Changed chart directories: ${{ steps.changes.outputs.dirs }}"
