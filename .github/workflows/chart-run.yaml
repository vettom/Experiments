name: Helm Chart CI

on:
  workflow_dispatch: # manual trigger
  pull_request:
    paths:
      - 'Helm-charts/**'  # only trigger if helm charts are modified

jobs:
  detect-and-package:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get changed helm chart directories
        id: changes
        run: |
          # Compare against base branch (for PRs)
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            git fetch origin ${{ github.base_ref }}
            CHANGED_DIRS=$(git diff --name-only origin/${{ github.base_ref }}...HEAD -- repo/helm-charts/ | cut -d/ -f1-3 | sort -u)
          else
            # For manual run, take all helm chart directories
            CHANGED_DIRS=$(find repo/helm-charts -mindepth 1 -maxdepth 1 -type d)
          fi

          echo "Changed directories:"
          echo "$CHANGED_DIRS"

          # Set output (multi-line safe)
          echo "dirs<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_DIRS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.15.4

      - name: Package changed charts
        if: steps.changes.outputs.dirs != ''
        run: |
          mkdir -p packaged
          for dir in ${{ steps.changes.outputs.dirs }}; do
            if [ -f "$dir/Chart.yaml" ]; then
              VERSION=$(yq '.version' "$dir/Chart.yaml")
              echo "Packaging chart $dir with version $VERSION"
              helm package "$dir" --destination packaged/
            fi
          done

    #   - name: Upload packaged charts as artifact
    #     if: steps.changes.outputs.dirs != ''
    #     uses: actions/upload-artifact@v4
    #     with:
    #       name: helm-charts
    #       path: packaged/
